# Асинхронная обработка AI оценок открытых ответов

## Описание

Система автоматической оценки открытых ответов теперь работает асинхронно. Это означает, что:

1. **Результаты сохраняются немедленно** — ответы пользователя сохраняются в базу данных сразу после отправки теста, без ожидания обработки AI
2. **Обработка AI происходит в фоне** — специальный фоновый сервис циклически проверяет наличие необработанных попыток и отправляет их на оценку AI
3. **Отслеживание статуса** — пользователь видит текущий статус обработки (ожидает, в обработке, завершено, ошибка)
4. **Защита от потери данных** — даже если AI недоступен или произошла ошибка, ответы пользователя сохранены и могут быть оценены позже

## Архитектура

### Компоненты

1. **TestAttempt (модель)** — расширена новыми полями:
   - `GradingStatus` — статус обработки AI (NotRequired, Pending, Processing, Completed, Failed)
   - `LastUpdatedAt` — дата последнего обновления
   - `GradingError` — сообщение об ошибке при неудачной обработке

2. **BackgroundGradingService** — фоновый сервис, который:
   - Запускается при старте приложения
   - Каждые 5 секунд проверяет наличие попыток со статусом `Pending`
   - Обрабатывает до 10 попыток за раз
   - Обновляет статус на `Processing` во время обработки
   - Устанавливает статус `Completed` при успехе или `Failed` при ошибке

3. **TestController** — изменен для немедленного сохранения:
   - Для открытых тестов устанавливает статус `Pending`
   - Сохраняет попытку в БД сразу после отправки
   - Перенаправляет на страницу результатов без ожидания AI

4. **Result.cshtml (представление)** — обновлено для отображения:
   - Статуса обработки с визуальными индикаторами
   - Даты последнего обновления
   - Сообщения об ошибке (если есть)
   - Кнопки обновления страницы для проверки статуса

### Статусы обработки

| Статус | Описание | Когда устанавливается |
|--------|----------|----------------------|
| `NotRequired` | Не требует обработки | Для закрытых тестов и самопроверки |
| `Pending` | Ожидает обработки | При сохранении открытого теста |
| `Processing` | В процессе обработки | Когда фоновый сервис начинает обработку |
| `Completed` | Обработка завершена | После успешной оценки AI или ручной оценки |
| `Failed` | Ошибка при обработке | При неудачной попытке оценки AI |

## Использование

### Для пользователей

1. Пройдите тест с открытыми ответами
2. Отправьте ответы — они будут сохранены немедленно
3. На странице результатов вы увидите статус "⏳ Ожидает обработки"
4. Обновите страницу через несколько секунд, чтобы увидеть результаты оценки AI
5. Если обработка завершена, вы увидите статус "✓ Обработано" и оценки по каждому вопросу

### Для администраторов

Администраторы могут:
- Просматривать статус обработки для всех попыток
- Вручную повторить оценку AI через кнопку "Повторить оценку ИИ"
- Установить оценки вручную, если AI не справился

## Настройка

### Интервал опроса

По умолчанию фоновый сервис проверяет новые попытки каждые 5 секунд. Чтобы изменить интервал, отредактируйте `BackgroundGradingService.cs`:

```csharp
private readonly TimeSpan _pollingInterval = TimeSpan.FromSeconds(5);
```

### Количество попыток за раз

По умолчанию обрабатывается до 10 попыток за раз. Чтобы изменить:

```csharp
.Take(10) // Обрабатываем до 10 попыток за раз
```

## Миграция базы данных

При первом запуске приложения после обновления автоматически будут добавлены новые колонки в таблицу `Attempts`:
- `GradingStatus` (INTEGER, по умолчанию 0)
- `LastUpdatedAt` (TEXT, по умолчанию текущая дата)
- `GradingError` (TEXT, nullable)

Миграция выполняется через `DatabaseMigrator.EnsureVersioningSchema()` при старте приложения.

## Обработка ошибок

Если при обработке AI произошла ошибка:
1. Статус устанавливается в `Failed`
2. Сообщение об ошибке сохраняется в `GradingError`
3. Попытка больше не обрабатывается автоматически
4. Администратор может повторить оценку вручную или установить оценки вручную

Типичные ошибки:
- AI провайдер недоступен
- Неверный API ключ
- Превышен лимит запросов
- Таймаут запроса

## Мониторинг

Фоновый сервис пишет логи:
- При запуске и остановке сервиса
- При обнаружении новых попыток для обработки
- При успешной обработке (с указанием среднего балла)
- При ошибках обработки

Пример логов:

```
[Information] BackgroundGradingService запущен
[Information] Найдено 3 попыток для обработки AI
[Information] Обработка попытки ID=42, TopicId=15
[Information] Попытка ID=42 успешно обработана, средний балл: 85.5%
[Error] Ошибка при обработке попытки ID=43: HttpRequestException: Connection refused
```

## Производительность

- **Нагрузка на БД**: минимальная, один запрос каждые 5 секунд
- **Нагрузка на AI**: до 10 запросов каждые 5 секунд (при наличии необработанных попыток)
- **Время обработки**: обычно 2-10 секунд на одну попытку (зависит от AI провайдера)
- **Масштабируемость**: сервис обрабатывает попытки последовательно, для высоких нагрузок можно увеличить количество попыток за раз

## Будущие улучшения

Возможные улучшения системы:
- Приоритизация обработки (например, по времени ожидания)
- Параллельная обработка нескольких попыток
- Автоматическое обновление страницы результатов через WebSocket или SignalR
- Повторная попытка обработки при временных ошибках
- Статистика по времени обработки и успешности
