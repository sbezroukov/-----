@model HomeCenter.Models.TestAttempt
@using System.Text.Json

@functions {
    string? GetJsonString(JsonElement elem, string prop)
    {
        if (!elem.TryGetProperty(prop, out var val)) return null;
        if (val.ValueKind == JsonValueKind.String) return val.GetString();
        if (val.ValueKind == JsonValueKind.Array)
        {
            var parts = val.EnumerateArray().Select(e => e.ValueKind == JsonValueKind.String ? e.GetString() : e.ToString()).Where(s => !string.IsNullOrEmpty(s));
            return string.Join("\n", parts);
        }
        return val.ToString();
    }
}

@{
    ViewData["Title"] = "–†–µ–∑—É–ª—å—Ç–∞—Ç";
    var details = ViewBag.Details as System.Collections.IEnumerable;
    var topic = Model.Topic;
    var user = Model.User;
}

@if (topic == null)
{
    <p class="text-danger">–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>
}
else
{
<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Ç–µ–º–µ "@topic.DisplayPath"</h2>

<div class="card mb-3">
    <div class="card-body">
        <p class="mb-1"><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> @(user?.UserName ?? "‚Äî")</p>
        <p class="mb-1"><strong>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è:</strong> @Model.StartedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</p>
        <p class="mb-1"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> @Model.LastUpdatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</p>
        <p class="mb-1"><strong>–¢–∏–ø —Ç–µ—Å—Ç–∞:</strong> @topic.TypeDisplayName</p>
        <p class="mb-1"><strong>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤:</strong> @Model.TotalQuestions</p>
        
        @if (topic.Type == HomeCenter.Models.TopicType.Open)
        {
            <p class="mb-1">
                <strong>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI:</strong>
                @switch (Model.GradingStatus)
                {
                    case HomeCenter.Models.GradingStatus.Pending:
                        <span class="badge bg-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>
                        <small class="text-muted ms-2">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –û—Ü–µ–Ω–∫–∞ AI –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥.</small>
                        break;
                    case HomeCenter.Models.GradingStatus.Processing:
                        <span class="badge bg-info">‚öôÔ∏è –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>
                        <small class="text-muted ms-2">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...</small>
                        break;
                    case HomeCenter.Models.GradingStatus.Completed:
                        <span class="badge bg-success">‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                        break;
                    case HomeCenter.Models.GradingStatus.Failed:
                        <span class="badge bg-danger">‚úó –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>
                        break;
                    default:
                        <span class="badge bg-secondary">‚Äî</span>
                        break;
                }
            </p>
            
            @if (Model.GradingStatus == HomeCenter.Models.GradingStatus.Failed && !string.IsNullOrEmpty(Model.GradingError))
            {
                <div class="alert alert-danger mb-1" role="alert">
                    <strong>–û—à–∏–±–∫–∞ AI:</strong> @Model.GradingError
                </div>
            }
            
            @if (Model.GradingStatus == HomeCenter.Models.GradingStatus.Pending || Model.GradingStatus == HomeCenter.Models.GradingStatus.Processing)
            {
                <div class="alert alert-info mb-1" role="alert">
                    <strong>üí° –°–æ–≤–µ—Ç:</strong> –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏ AI.
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="btnRefreshResults">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                    </button>
                </div>
                <script>
                    document.getElementById('btnRefreshResults').addEventListener('click', function() {
                        if (window.LoadingIndicator) window.LoadingIndicator.show(true);
                        location.reload();
                    });
                </script>
            }
        }
        
        @if (Model.ScorePercent.HasValue)
        {
            <p class="mb-0">
                <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> 
                <span class="badge @(Model.ScorePercent >= 70 ? "bg-success" : Model.ScorePercent >= 50 ? "bg-warning" : "bg-danger")">
                    @($"{Model.ScorePercent:F2} %")
                </span>
                @if (Model.CorrectAnswers.HasValue)
                {
                    <span>(@Model.CorrectAnswers –∏–∑ @Model.TotalQuestions –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)</span>
                }
            </p>
        }
        else
        {
            <p class="mb-0"><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏</p>
        }
    </div>
</div>

@if (details != null && details.Cast<object>().Any())
{
    <h3>–î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–æ–≤</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th style="width: 5%">‚Ññ</th>
                <th style="width: 35%">–í–æ–ø—Ä–æ—Å</th>
                @if (topic.Type == HomeCenter.Models.TopicType.Test)
                {
                    <th style="width: 25%">–í–∞—à –æ—Ç–≤–µ—Ç</th>
                    <th style="width: 25%">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</th>
                    <th style="width: 10%">–°—Ç–∞—Ç—É—Å</th>
                }
                else if (topic.Type == HomeCenter.Models.TopicType.Open)
                {
                    <th style="width: 25%">–í–∞—à –æ—Ç–≤–µ—Ç</th>
                    <th style="width: 25%">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</th>
                    <th style="width: 5%">–û—Ü–µ–Ω–∫–∞ %</th>
                }
                else
                {
                    <th style="width: 55%">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                }
            </tr>
        </thead>
        <tbody>
            @{
                int questionNum = 1;
                foreach (var detail in details.Cast<object>())
                {
                    var jsonElement = detail as System.Text.Json.JsonElement?;
                    if (jsonElement == null) continue;
                    
                    var elem = jsonElement.Value;
                    <tr>
                        <td>@questionNum</td>
                        <td>@(elem.TryGetProperty("Question", out var qProp) ? qProp.GetString() : "‚Äî")</td>
                        
                        @if (topic.Type == HomeCenter.Models.TopicType.Test)
                        {
                            var selected = GetJsonString(elem, "Selected") ?? "–ù–µ –≤—ã–±—Ä–∞–Ω";
                            var correct = GetJsonString(elem, "Correct") ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
                            var isCorrect = elem.TryGetProperty("IsCorrect", out var isCor) && isCor.GetBoolean();
                            
                            <td><div style="white-space: pre-wrap;">@selected</div></td>
                            <td><div style="white-space: pre-wrap;">@correct</div></td>
                            <td>
                                @if (isCorrect)
                                {
                                    <span class="badge bg-success">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                                }
                            </td>
                        }
                        else if (topic.Type == HomeCenter.Models.TopicType.Open)
                        {
                            var answer = GetJsonString(elem, "Answer") ?? "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞";
                            var correct = GetJsonString(elem, "Correct");
                            var scorePercent = elem.TryGetProperty("ScorePercent", out var sp) && sp.ValueKind == JsonValueKind.Number ? sp.GetDouble() : (double?)null;
                            <td>
                                @if (string.IsNullOrWhiteSpace(answer))
                                {
                                    <em class="text-muted">–û—Ç–≤–µ—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω</em>
                                }
                                else
                                {
                                    <div style="white-space: pre-wrap;">@answer</div>
                                }
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(correct))
                                {
                                    <em class="text-muted">‚Äî</em>
                                }
                                else
                                {
                                    <div style="white-space: pre-wrap;">@correct</div>
                                }
                            </td>
                            <td>
                                @if (scorePercent.HasValue)
                                {
                                    <span class="badge @(scorePercent >= 70 ? "bg-success" : scorePercent >= 50 ? "bg-warning" : "bg-danger")">@($"{scorePercent:F0}%")</span>
                                }
                                else
                                {
                                    <em class="text-muted">‚Äî</em>
                                }
                            </td>
                        }
                        else
                        {
                            <td><em class="text-muted">–í–æ–ø—Ä–æ—Å –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏</em></td>
                        }
                    </tr>
                    questionNum++;
                }
            }
        </tbody>
    </table>
}

@if (User.IsInRole("Admin") && topic != null && topic.Type == HomeCenter.Models.TopicType.Open && details != null && details.Cast<object>().Any())
{
    <hr />
    <h4>–û—Ü–µ–Ω–∫–∞ (–∞–¥–º–∏–Ω)</h4>
    <div class="mb-3">
        <form asp-controller="Admin" asp-action="RegradeAttempt" method="post" class="d-inline me-2">
            @Html.AntiForgeryToken()
            <input type="hidden" name="attemptId" value="@Model.Id" />
            <button type="submit" class="btn btn-outline-info btn-sm">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ü–µ–Ω–∫—É –ò–ò</button>
        </form>
    </div>
    <h5 class="mt-3">–†—É—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞</h5>
    <form asp-controller="Admin" asp-action="RateAttempt" method="post" class="mb-3">
        <input type="hidden" name="attemptId" value="@Model.Id" />
        @{
            int qi = 0;
            foreach (var detail in details.Cast<object>())
            {
                var jsonElement = detail as System.Text.Json.JsonElement?;
                if (jsonElement == null) continue;
                var elem = jsonElement.Value;
                var curScore = elem.TryGetProperty("ScorePercent", out var sp) && sp.ValueKind == JsonValueKind.Number ? sp.GetDouble() : (double?)null;
                <div class="mb-2">
                    <label class="form-label">–í–æ–ø—Ä–æ—Å @(qi + 1): %</label>
                    <input type="number" name="scores[@qi]" value="@(curScore?.ToString("F0") ?? "")" min="0" max="100" step="1" class="form-control form-control-sm" style="width: 80px;" placeholder="0‚Äì100" />
                </div>
                qi++;
            }
        }
        <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
    </form>
}

}
<p>
    <a class="btn btn-primary" asp-controller="Account" asp-action="History">–ö –∏—Å—Ç–æ—Ä–∏–∏</a>
    <a class="btn btn-secondary" asp-action="Index">–ö —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</a>
</p>

